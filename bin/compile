#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast
set -e

# Debug
# set -x

# Clean up leaking environment
unset GIT_DIR

# Setup profile file
PROFILE_PATH="$BUILD_DIR/.profile.d/geo.sh"
mkdir -p $(dirname $PROFILE_PATH)

# Functions
function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

function set-env (){
  echo "export $1=$2" >> $PROFILE_PATH
}

function set-default-env (){
  echo "export $1=\${$1:-$2}" >> $PROFILE_PATH
}

# Display some information
echo "Setting environment variables..." | indent

# Setup environment variables
set-env REPORTED_STACK "$STACK"
set-env REPORTED_BUILD_DIR "$1"
set-env REPORTED_CACHE_DIR "$2"
set-env REPORTED_ENV_DIR "$3"

# Print out environment variables
echo "Reported STACK: $STACK"
echo "Reported BUILD_DIR: $1"
echo "Reported CACHE_DIR: $2"
echo "Reported ENV_DIR: $3"
